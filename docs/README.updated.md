<!--
###############################################################
# README.md
# Purpose:
#  - Quickstart for this Terraform + GitHub Actions repo.
#  - How to bootstrap backend + OIDC.
#  - What each workflow does (incl. Destroy + Admin).
#  - Git flow cheat-sheet + links to full guide.
###############################################################
-->

# Infra Repo — Terraform + GitHub Actions (OIDC, S3 backend)

This repo uses:
- **S3** (versioned, encrypted) for Terraform state
- **DynamoDB** for state locking
- **AWS IAM OIDC** trust with **GitHub Actions** (no long-lived keys)
- Protected branches and **squash-only** merges (via Terraform-managed rules)
- A clear **Git flow**: `main`, `develop`, `feature/*`, `release/*`, `hotfix/*`

> Full workflow guide (features → releases → hotfixes → sync main → develop):  
> **docs:** `docs/git-workflow-mastery.md` • **HTML:** `docs/git-workflow-mastery.html`  
> **Download latest copies generated by ChatGPT:**  
> - Markdown: `docs/git-workflow-mastery.md` (commit to repo)  
> - HTML: `docs/git-workflow-mastery.html` (commit to repo)

---

## Workflow Index (what runs, when)

- **`05 - PR Quality Gate`** (PRs only)  
  *fmt → validate → TFLint → Checkov → plan; non-strict required check to avoid “Expected” hangs.*

- **`10 - Terraform`** (plan on branches/PRs, **apply only on push to `main`**)  
  *Uses OIDC; gated by Environment **`production`** (add reviewers).*

- **`90 - Terraform Destroy (manual)`** *(new)*  
  *Manual-only, guarded with confirmation phrase, restricted to `main`, uses Environment `production`. Shows `plan -destroy` artifact; can run plan-only mode.*

- **`99 - Apply GitHub Rulesets`** (manual admin)  
  *Imports repo + rulesets to Terraform state and applies branch protections + squash-only merge settings.*

> Required check name: **`05 - PR Quality Gate / pr-quality`**. Trigger with:
>
> ```yaml
> on:
>   pull_request:
>     branches: ["**"]
>     types: [opened, synchronize, reopened]
>   merge_group: {}
> ```

---

## 1) One-time Bootstrap (creates backend + OIDC + repo variables)

### Prerequisites (repo settings)
- **Secrets** → add temporary AWS keys (delete after success):
  - `AWS_ACCESS_KEY_ID`
  - `AWS_SECRET_ACCESS_KEY`
- **(Optional) Secret** → `GH_ADMIN_TOKEN` (repo admin PAT) if you want Terraform to populate repo variables automatically.
- **Variables** (not secret):
  - `AWS_REGION` (e.g., `us-east-1`)

### Run the bootstrap workflow
GitHub → **Actions** → **“00 - Bootstrap AWS Backend”** → **Run workflow** and fill inputs:
- `bucket_name` → globally unique (e.g., `my-tfstate-12345`)
- `dynamodb_table_name` → e.g., `tf-locks-my-tfstate-12345`
- `tf_state_key` → e.g., `infra/terraform.tfstate`
- `github_owner` → e.g., `bond50`
- `github_repo` → this repository name (no owner)
- `project_name` → short tag prefix (e.g., `web-apps`)

**Creates**
- S3 bucket (+versioning +encryption +TLS-only)
- DynamoDB table for tfstate locks
- OIDC provider + IAM role `*-gha` for this repo
- GitHub repo variables (if PAT given):
  - `AWS_REGION`, `AWS_ROLE_ARN`, `TF_STATE_BUCKET`, `TF_STATE_TABLE`, `TF_STATE_KEY`

> After success, **delete** the temporary AWS keys from repo secrets. OIDC is now in place.

---

## 2) Daily Flow (features → releases → hotfixes → sync)

- **Feature** → branch from `develop` → PR to `develop` → **squash** when green
- **Release** → `release/*` off `develop` → PR to `main` → **squash** → **sync PR `main → develop`**
- **Hotfix** → `hotfix/*` off `main` → PR to `main` → **squash** → **back‑merge `main → develop`** (sync PR)
- **Apply** happens **only on push to `main`**, gated by **Environment `production`**

> **Parity proof** (content, not SHAs):  
> ```bash
> git fetch origin --prune
> git rev-parse origin/main^{tree}; git rev-parse origin/develop^{tree}
> # If identical, content is identical. Otherwise:
> git diff --name-status origin/main origin/develop
> ```

See **`docs/git-workflow-mastery.md`** for the full, copy‑pasteable flows (including cherry‑pick releases and conflict playbook).

---

## 2.5) Terraform Destroy (Manual, Safeguarded)

**When to use:** only for non‑prod sandboxes or controlled teardowns.  
**Protection:** typed confirmation, runs only on `main`, environment `production` approval.

**Run via GitHub UI → Actions → “90 - Terraform Destroy (manual)”**  
Inputs:
- **confirm**: `I UNDERSTAND THIS WILL DESTROY ALL RESOURCES` (exactly)
- **workspace**: e.g., `default` / `prod` / `staging`
- **directory**: TF root (default `.`)
- **state_key_suffix**: appended to `TF_STATE_KEY`, e.g., `live/terraform.tfstate`
- **plan_only**: `true` to review the destroy plan without destroying

**CLI parity (if needed)**
```bash
terraform init   -backend-config="bucket=$TF_STATE_BUCKET"   -backend-config="key=$TF_STATE_KEY/live/terraform.tfstate"   -backend-config="region=$AWS_REGION"   -backend-config="use_lockfile=true"   -backend-config="encrypt=true"

terraform workspace select default || terraform workspace new default
terraform plan -destroy -out=tfplan.destroy
terraform destroy -auto-approve
```

---

## 3) Local sanity (nice to run before pushing)

```bash
terraform fmt -recursive && terraform validate
tflint --init && tflint -f compact
checkov -d . --framework terraform
```

Optional pre-commit hooks:
```bash
pip install pre-commit
pre-commit install
pre-commit run -a
```

---

## 4) Folder Structure

```text
.
├── backend.tf
├── providers.tf
├── data.tf
├── variables.tf
├── locals.tf
├── main.tf
├── outputs.tf
│
├── docs/
│   ├── git-workflow-mastery.md
│   └── git-workflow-mastery.html
│
├── modules/
│   └── ...
│
├── bootstrap/
│   ├── main.tf
│   ├── variables.tf
│   └── outputs.tf
│
├── .github/
│   ├── workflows/
│   │   ├── 05-pr-quality-gate.yml
│   │   ├── 10-terraform.yml
│   │   ├── 90-terraform-destroy.yml         # NEW
│   │   └── 99-apply-github-rulesets.yml
│   └── pull_request_template.md
│
├── .tflint.hcl
├── .checkov.yml
├── .pre-commit-config.yaml
├── CODEOWNERS
└── README.md
```

---

## 5) Troubleshooting

- **“PR Gate — Expected” won’t clear** → ensure triggers include `synchronize` and `merge_group`, and remove any legacy protection expecting a differently‑named check.
- **Repo creation 422 in Admin workflow** → import the repo into TF state **before** apply.
- **S3 backend deprecation warning** → use `use_lockfile=true` instead of `dynamodb_table`.
- **Fast‑forward develop from main fails** → expected with squash merges; use a small **sync PR** `main → develop`.


---

## 6) Links

- **Full Git workflow guide:** `docs/git-workflow-mastery.md` / `docs/git-workflow-mastery.html`
- **Contributor guide:** `CONTRIBUTING.md`
- **Rulesets docs:** `github/rulesets.tf`
